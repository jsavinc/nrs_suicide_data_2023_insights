---
title: "NRS suicide data 2023 insights"
author: "Jan Savinc"
format: 
  html:
    toc: true
    code-fold: true
editor_options: 
  chunk_output_type: console
---


# Packages

```{r}
# note: there is an error when rendering quarto doc using quarto version 1.3.353 and knitr 1.43; downgrading knitr to 1.42 solves it, and newer versions of quarto will solve it also

require(pacman)
pacman::p_load(
  "tidyverse",
  "readxl",
  "janitor",
  "DT",
  "patchwork",
  "glue"
)
```

# Functions

```{r}
output_table_with_csv_button <- function(data_tbl, filename, caption = NULL) {
	require(DT)
	DT::datatable(
		data = data_tbl,
		caption = caption,
		extensions = "Buttons",
		options = list(
			pageLength = 200,
			dom = "Bfrtip",
			buttons = list(
				list(extend = "csv", filename = filename)  # adds .csv extension automatically
			)
		),
		class = "cell-border stripe",  # striped display of data for readability
		rownames = FALSE  # don't number rows
	)
}

create_age_groups_to_match_previous_release <- function(age_group_variable) {
  case_when(
    age_group_variable %in% c("0", "1_4", "5_9", "10_14") ~ "0-14",
    age_group_variable %in% c("15_19", "20_24") ~ "15-24",
    age_group_variable %in% c("25_29", "30_34") ~ "25-34",
    age_group_variable %in% c("35_39", "40_44") ~ "35-44",
    age_group_variable %in% c("45_49", "50_54") ~ "45-54",
    age_group_variable %in% c("55_59", "60_64") ~ "55-64",
    age_group_variable %in% c("65_69", "70_74") ~ "65-74",
    age_group_variable %in% c("75_79", "80_84", "85_89", "90_or_more") ~ "75+",
    TRUE ~ age_group_variable
  )
}

create_five_year_periods <- function(year_variable) {
  min_year = min(year_variable)
  max_year = max(year_variable)
  last_year = max(year_variable)-4
  five_year_periods <- paste0(min_year:last_year, "-", (min_year+4):max_year)
  return(five_year_periods)
}
```



# Download data
  
Note: this is based on the 2022 data release, reporting on probable deaths by suicide up to 2021.
I'm assuming the 2023 format will be the same as 2022, so I can swap out for the later file once it's released here.

```{r}
url_2022 <- "https://www.nrscotland.gov.uk/files//statistics/probable-suicides/2021/suicides-21-all-tabs.xlsx"

# TODO: change once it's available!
url_2023 <- "https://www.nrscotland.gov.uk/files//statistics/probable-suicides/2022/suicides-22-all-tabs.xlsx"

if (!dir.exists("./data/")) dir.create("./data")

download.file(url = url_2022, destfile = file.path("./data", basename(url_2022)), mode = "wb")

# TODO: load separate sheets as required
# data_2022 <- read_excel(path = file.path("./data", basename(url_2022)))

path_to_data <- file.path("./data", basename(url_2022))
```

# Load data

Note: I load data as required for the below tables & charts


# 'Chart 1': age-standardised mortality rate by sex

```{r}
table_1 <- 
  read_excel(path_to_data, sheet = "Table_1", skip = 4) %>%
  clean_names

age_sex_standardided_mort <-
  table_1 %>%
  pivot_longer(
    cols = 
      c(
        age_standardised_mortality_rate_persons,
        age_standardised_mortality_rate_females,
        age_standardised_mortality_rate_males
      ),
    names_to = "sex", values_to = "asmr", names_transform = ~str_extract(.x, pattern = "(persons|males|females)$")
  ) %>%
  select(year, sex, asmr) %>%
  distinct %>%
  mutate(
    year = as.integer(year),
    sex = factor(sex, levels = c("persons","males","females"))
    ) %>%
  filter(!is.na(asmr))
  
(chart_1 <- 
  ggplot(
    data = age_sex_standardided_mort,
    aes(x = year, y = asmr, colour = sex)
  ) +
    geom_line() +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    scale_x_continuous(limits = c(1994,max(age_sex_standardided_mort$year)), breaks = seq.int(1994, 2022, by = 2)) +  # eh, good enough
    scale_y_continuous(breaks = scales::pretty_breaks(n = 6), limits = c(0,NA)) +
    scale_colour_manual(values = c("black","red","blue"), labels = c("All", "Male", "Female")) +
    labs(
      title = "Chart 1. Suicide rates, Scotland, all ages",
      subtitle = "Source: NRS",
      y = "Age-sex standardised rate per 100,000",
      x = NULL
      )
)
```


# Five-year averages

These are included in Tables 3B & 4B, alongside the Health Board/Local Authority split

```{r}
table_3b <- 
  read_excel(path_to_data, sheet = "Table_3B", skip = 4) %>%
  clean_names %>%
  mutate(
    year_5 = str_replace_all(year, pattern = "to", replacement = "-") %>%
      factor,
  ) %>% 
  select(-year) %>%
  relocate(year_5)

five_year_averages <- table_3b %>%
  filter(health_board == "Scotland") %>%
  select(-health_board)

five_year_averages %>%
  output_table_with_csv_button(filename = "five_year_averages", caption = "Five year averages of age-standardised mortality rate fue to probable suicide.") %>%
  DT::formatRound(columns = 2:4, digits = 2)
```


# 'Chart 2 & 3': 5-year ASMR by age group & sex, comparing decades apart

This uses data from Table 2B, with some age categories collapsed to form larger age groups (though those age groups are not the same as the 'Larger age groups' included in the NRS data).

```{r}
table_2b <-
  read_excel(path_to_data, sheet = "Table_2B", skip = 4) %>%
  clean_names %>%
  mutate(
    sex = factor(sex, levels = c("Persons", "Males", "Females"))
  )

crude_rate_by_age_group_by_year <-
  table_2b %>%
  pivot_longer(
    cols = age_0:age_90_or_more,
    names_to = "age_group",
    values_to = "crude_rate",
    names_transform = ~ str_remove_all(.x, pattern = "age\\_")
  ) %>%
  mutate(
    age_group_new = create_age_groups_to_match_previous_release(age_group)
  ) %>%
  group_by(year, sex, age_group_new) %>%
  summarise(
    crude_rate = mean(crude_rate),
    .groups = "drop"
  ) %>%
  (function(data_tbl) {
    bind_rows(
      data_tbl,
      data_tbl %>%
        group_by(year,sex) %>%
        summarise(
          crude_rate = mean(crude_rate),
          age_group_new = "All ages",
          .groups = "drop"
          )
      )
  })

crude_rate_by_age_group_by_five_years <-
  map_dfr(
    .x = min(crude_rate_by_age_group_by_year$year) : (max(crude_rate_by_age_group_by_year$year)-4),
    .f = function(year_start) {
      crude_rate_by_age_group_by_year %>%
        filter(year %in% year_start:(year_start+4)) %>%
        group_by(age_group_new, sex) %>%
        summarise(
          year_5 = paste0(year_start,"-",year_start+4),
          crude_rate = mean(crude_rate),
          .groups = "drop"
          )
    }
  ) %>%
  relocate(year_5)

current_5_year_group <- max(crude_rate_by_age_group_by_five_years$year_5)
twenty_years_before_5_year_group <- paste0(
  parse_number(current_5_year_group)-20,"-",parse_number(current_5_year_group)-16
)

(chart_2_and_3 <-
  crude_rate_by_age_group_by_five_years %>%
  filter(year_5 %in% c(current_5_year_group, twenty_years_before_5_year_group)) %>%
  ggplot(data = ., aes(x=age_group_new, y=crude_rate, fill = year_5)) +
  geom_col(position = position_dodge(width = 0.8), width=0.8, colour = "grey10") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.title = element_blank()
    ) +
  scale_colour_manual(values = c("black","red","blue"), labels = c("All", "Male", "Female")) +
    facet_wrap(~sex) +
    labs(
      x = NULL, 
      y = "Age-specific crude rate per 100,000", 
      title = "Chart 2 & 3. Deaths by suicide over time by age group",
      subtitle = "Source: NRS"
      )
)
```


# Ratio of most deprived SIMD to least deprived

This is computed from quintiles 1 (most deprived) & 5 (least deprived) in Table 5.

Note: I originally plotted both the ASMR and death ratios - they are virtually the same.

```{r}
table_5 <- 
  read_excel(path_to_data, sheet = "Table_5", skip = 4) %>%
  clean_names %>%
  mutate(
    sex = factor(sex, levels = c("Persons", "Males", "Females"))
  )

ratio_simd_most_to_least_deprived <-
  table_5 %>%
  group_by(year, sex) %>%
  summarise(
    ratio_asmr = age_standardised_rate_of_mortality_asmr[simd_quintile==1] / age_standardised_rate_of_mortality_asmr[simd_quintile==5],
    ratio_deaths = deaths[simd_quintile==1] / deaths[simd_quintile==5],
    .groups = "drop"
  ) %>%
  arrange(sex)


ratio_simd_most_to_least_deprived %>%
  output_table_with_csv_button(filename = "ratio_simd_most_to_least_deprived", caption = "Ratio of sex-specific age standardised mortality rate (ASMR) in most deprived SIMD quintile (1) to least deprived quintile (5).") %>%
  DT::formatRound(columns = 3:4, digits = 2)


(fig_ratio_simd <-
  ggplot(data = ratio_simd_most_to_least_deprived, aes(x=year, y=ratio_asmr, colour=sex)) +
  geom_line() +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_continuous(limits = c(2001,max(ratio_simd_most_to_least_deprived$year)), breaks = seq.int(2001, 2023, by = 2)) +  # eh, good enough
  scale_y_continuous(breaks = scales::pretty_breaks(n = 6), limits = c(0,NA)) +
  scale_colour_manual(values = c("black","red","blue"), labels = c("All", "Male", "Female")) +
    labs(
      x = NULL, 
      y = "Ratio of most to least deprived SIMD", 
      title = "Age-standardised mort. ratio (ASMR)",
      subtitle = "Source: NRS"
      )
)
```


# Summaries of changes from last year

```{r}
this_year <- max(age_sex_standardided_mort$year)
last_year <- this_year - 1
```

## By sex & age group

```{r}
crude_rate_by_age_group_by_year %>%
  filter(year %in% c(last_year, this_year)) %>%
  pivot_wider(names_from = age_group_new, values_from = crude_rate) %>%
  arrange(sex) %>%
  output_table_with_csv_button(filename = paste0("crude_rate_by_age_group_and_sex","_",last_year,"_",this_year), caption = "Crude rate of deaths by 100,000 population by age group & sex, comparing this year & last.") %>%
  DT::formatRound(columns = 3:11, digits = 2)

(fig_changes_age_group_sex <-
  crude_rate_by_age_group_by_year %>%
  filter(year %in% c(last_year, this_year)) %>%
  ggplot(data = ., aes(x=age_group_new, y=crude_rate, fill = factor(year))) +
  geom_col(position = position_dodge(width = 0.8), width=0.8, colour = "grey10") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.title = element_blank()
    ) +
  scale_colour_manual(values = c("black","red","blue"), labels = c("All", "Male", "Female")) +
    facet_wrap(~sex) +
    labs(
      x = NULL, 
      y = "Age-specific crude rate per 100,000", 
      title = str_wrap(glue("Deaths by suicide over time by age group & sex: changes between {last_year} & {this_year}")),
      subtitle = "Source: NRS"
      )
)
```

## By SIMD

```{r}
table_5 %>%
  filter(year %in% c(last_year, this_year)) %>%
  output_table_with_csv_button(filename = paste0("asmr_by_SIMD_sex","_",last_year,"_",this_year), caption = "Age-standardised rate of mortality (ASMR) by SIMD quintile (1=most deprived) and sex, comparing this year & last.") %>%
  DT::formatRound(columns = 5:7, digits = 2)


(fig_changes_simd_sex <-
  table_5 %>%
  filter(year %in% c(last_year, this_year)) %>%
  mutate(simd_quintile = factor(if_else(simd_quintile==1, paste0(simd_quintile, ": ", quintile_description), as.character(simd_quintile)))) %>%
  ggplot(data = ., aes(x=simd_quintile, y=age_standardised_rate_of_mortality_asmr, fill = factor(year))) +
  geom_col(position = position_dodge(width = 0.8), width=0.8, colour = "grey10") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.title = element_blank()
    ) +
  scale_colour_manual(values = c("black","red","blue"), labels = c("All", "Male", "Female")) +
    facet_wrap(~sex) +
    labs(
      x = NULL, 
      y = "Age-specific crude rate per 100,000", 
      title = str_wrap(glue("Deaths by suicide over time by SIMD & sex: changes between {last_year} & {this_year}")),
      subtitle = "Source: NRS"
      )
)
```


